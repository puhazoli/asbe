---

title: Basic functionalities


keywords: fastai
sidebar: home_sidebar



nb_path: "00_base.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_base.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FitTask" class="doc_header"><code>class</code> <code>FitTask</code><a href="https://github.com/puhazoli/asbe/tree/master/asbe/base.py#L19" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FitTask</code>(<strong><code>name</code></strong>, <strong><code>bases</code></strong>, <strong><code>clsdict</code></strong>) :: <code>type</code></p>
</blockquote>
<p>Meta class to make preprocessing of data before fitting different models</p>
<p>This meta class is needed so new models can be incorporated easily
by only having a .fit() method. It will call a prepare_data function, which
can also be modified .</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseITEEstimator" class="doc_header"><code>class</code> <code>BaseITEEstimator</code><a href="https://github.com/puhazoli/asbe/tree/master/asbe/base.py#L53" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseITEEstimator</code>(<strong><code>model</code></strong>:<code>Union</code>[<code>str</code>, <code>Callable</code>]=<em><code>None</code></em>, <strong><code>dataset</code></strong>:<code>Optional</code>[<code>dict</code>]=<em><code>None</code></em>, <strong><code>two_model</code></strong>:<code>Optional</code>[<code>bool</code>]=<em><code>None</code></em>, <strong><code>ps_model</code></strong>:<code>Optional</code>[<code>Callable</code>]=<em><code>None</code></em>, <strong>**<code>kwargs</code></strong>) :: <code>BaseEstimator</code></p>
</blockquote>
<p>Base class for estimating treatment effects</p>
<p>This is a base class, that is also usable on its own to estimate treatment effects.
It works with most models that have a .fit() method, but subclassing is also made
straightforward throught a metaclass.</p>
<h2 id="Attributes">Attributes<a class="anchor-link" href="#Attributes"> </a></h2><p>model : str, Callable
    treatment effect estimator to be used
dataset: dict, BaseDataGenerator
    dataset to be used by the model, either offline or online
two_model: bool
    Switches between S or T learner approach, when appropriate
ps_model: Callable, None
    Propensity score model, if used, must be classifier</p>
<h2 id="Methods">Methods<a class="anchor-link" href="#Methods"> </a></h2><p>prepare_data(X_training, t_training, y_training, ps_scores):
    Puts together data for training before .fit() is called</p>
<p>fit(X_training, t_training, y_training, ps_scores):
    Fits the treatment effect estimator to the training data</p>
<p>predict(X, ps_scores):
    Predicts the treatment effects based on the supplied X</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">LogisticRegression</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="n">bite</span> <span class="o">=</span> <span class="n">BaseITEEstimator</span><span class="p">(</span><span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(),</span>
                        <span class="n">two_model</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">ps_model</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10000</span><span class="p">,))</span>
<span class="n">y0</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
<span class="n">ite</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">ite</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
<span class="n">bite</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_training</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span>
         <span class="n">t_training</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span>
         <span class="n">y_training</span> <span class="o">=</span> <span class="n">y</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">bite</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">bite</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">bite</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">preds</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">bite</span><span class="o">.</span><span class="n">model</span><span class="p">),</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">_base</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">bite</span><span class="o">.</span><span class="n">ps_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">bite</span><span class="o">.</span><span class="n">ps_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">bite</span><span class="o">.</span><span class="n">ps_model</span><span class="p">),</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">_logistic</span><span class="o">.</span><span class="n">LogisticRegression</span><span class="p">)</span>
<span class="n">bite</span><span class="o">.</span><span class="n">ps_model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">bite</span><span class="o">.</span><span class="n">two_model</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">bite</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_training</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span>
        <span class="n">t_training</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span>
        <span class="n">y_training</span> <span class="o">=</span> <span class="n">y</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">bite</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseActiveLearner" class="doc_header"><code>class</code> <code>BaseActiveLearner</code><a href="https://github.com/puhazoli/asbe/tree/master/asbe/base.py#L239" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseActiveLearner</code>(<strong><code>estimator</code></strong>:<code>BaseEstimator</code>, <strong><code>acquisition_function</code></strong>:<code>Callable</code>, <strong><code>assignment_function</code></strong>:<code>Union</code>[<code>Callable</code>, <code>list</code>, <code>NoneType</code>], <strong><code>stopping_function</code></strong>:<code>Union</code>[<code>Callable</code>, <code>list</code>, <code>NoneType</code>], <strong><code>dataset</code></strong>:<code>dict</code>, <strong><code>al_steps</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>offline</code></strong>=<em><code>True</code></em>, <strong>**<code>kwargs</code></strong>) :: <code>BaseEstimator</code></p>
</blockquote>
<p>Basic of Active Learners later used, with the capability for treatment effects</p>
<p>Inspired by modAL's BaseLearner, however modified for ITE estimation. Dataset is provided by
a dictionary for easier usage and less clutter, but alternatively a BaseDataGenerator can
also be supplied.</p>
<h2 id="Attributes">Attributes<a class="anchor-link" href="#Attributes"> </a></h2><p>estimator: BaseEstimator
    Estimator for treatment effects, which expects a BaseEstimator or a subclass of it
acquisition_function:
    Method that selects units to label
assignment_function:
    Method that selects control or treatment for selected units
stopping_function:
    Method that determines if the active learning process should stop after the current step
dataset : dict, BaseDataGenerator
    Dataset that is used for the active learning process
al_steps : int = 1
    number of active learnign steps to take. Can be controlled from the outside by self.current_step
offline : bool
    Determines whether data is supplied beforehand or created on the fly</p>
<h2 id="Methods">Methods<a class="anchor-link" href="#Methods"> </a></h2><p>fit():
    Fits the supplied estimator with data from dataset
predict(X):
    Predicts X with the estimator
query(no_query = None, acquisition_function = None):
    Calls the acquisition function to query datapoints to label.
    Number of queries and AF can be supplied, which overwrited the active learner's
    at the current step
teach(query_idx=None, assignment_function = None, **kwargs):
    Teaches the supplied indices, by moving them to the training set and
    selects the counterfactuals used
score(metric="PEHE"):
    Uses a test set to calculate a metric from the estimator
simulate(no_query: int = None, metric: str = "Qini")
    Simulates the active learning process by going through al_steps.
    The metric for the simulation to be saved can be set
plot():
    Plots the typical active learning style line plot, after simulation
    has finished.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseAcquisitionFunction" class="doc_header"><code>class</code> <code>BaseAcquisitionFunction</code><a href="https://github.com/puhazoli/asbe/tree/master/asbe/base.py#L622" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseAcquisitionFunction</code>(<strong><code>no_query</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>method</code></strong>:<code>str</code>=<em><code>'top'</code></em>, <strong><code>name</code></strong>:<code>str</code>=<em><code>'base'</code></em>)</p>
</blockquote>
<p>Base class for acquisition functions</p>
<p>Based on Eq. 3 in paper:</p>

<pre><code>- calculate_metrics is used to get infromativeness/representativeness
- calculate_metrics returns a weighted average between the two
- select_data does the normalization and selecting top m/Bernoulli draws

</code></pre>
<h2 id="Attributes">Attributes<a class="anchor-link" href="#Attributes"> </a></h2><p>no_query : int = 1
    Number of queries
method : str = "top"
    Way to select the data after metrics are calculated
name : str
    Name of the AF, used in simulations</p>
<h2 id="Methods">Methods<a class="anchor-link" href="#Methods"> </a></h2><p>calculate_metrics(model, dataset):
    User defined method to get different metrics about the pool set
select_data(model, dataset, no_query):
    Based on the calculated metrics, selects the data to be added to the
    training set.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseAssignmentFunction" class="doc_header"><code>class</code> <code>BaseAssignmentFunction</code><a href="https://github.com/puhazoli/asbe/tree/master/asbe/base.py#L722" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseAssignmentFunction</code>(<strong><code>base_selection</code></strong>=<em><code>0</code></em>)</p>
</blockquote>
<p>Base class for assignment functions</p>
<h2 id="Arguments">Arguments<a class="anchor-link" href="#Arguments"> </a></h2><p>base_selection : int = 0
    Which treatment to select automatically</p>
<h2 id="Methods">Methods<a class="anchor-link" href="#Methods"> </a></h2><p>select_treatment(model, dataset, query_idx)
    Selects the treaatment based on the model and the dataset.
    Predictions can only be done for the selected indices to save time.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseStoppingRule" class="doc_header"><code>class</code> <code>BaseStoppingRule</code><a href="https://github.com/puhazoli/asbe/tree/master/asbe/base.py#L744" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseStoppingRule</code>(<strong><code>budget</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Base class for providing a stopping rule for the active learner</p>
<h2 id="Arguments">Arguments<a class="anchor-link" href="#Arguments"> </a></h2><p>budget : int = None
    The budget that the active learner can use to run simulations</p>
<h2 id="Methods">Methods<a class="anchor-link" href="#Methods"> </a></h2><p>check_rules(model, dataset, step)
    The method to check if the condition is reached to stop the active
    learning loop</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseDataGenerator" class="doc_header"><code>class</code> <code>BaseDataGenerator</code><a href="https://github.com/puhazoli/asbe/tree/master/asbe/base.py#L771" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseDataGenerator</code>(<strong><code>ds</code></strong>:<code>Union</code>[<code>dict</code>, <code>Callable</code>], <strong><code>dgp_x</code></strong>:<code>Optional</code>[<code>Callable</code>]=<em><code>None</code></em>, <strong><code>dgp_t</code></strong>:<code>Optional</code>[<code>Callable</code>]=<em><code>None</code></em>, <strong><code>dgp_y</code></strong>:<code>Optional</code>[<code>Callable</code>]=<em><code>None</code></em>, <strong><code>no_training</code></strong>:<code>int</code>=<em><code>10</code></em>)</p>
</blockquote>
<p>Class to generate online data for active learing purposes</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

